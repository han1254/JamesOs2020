# 1. Environment setup

ğŸ‘‰é¦–å…ˆä½ è¦æœ‰ä¸€ä¸ªlinuxç³»ç»Ÿï¼Œå¯ä»¥æ˜¯è™šæ‹Ÿæœºï¼Œæœ‰ä¸€ä¸ªå°±è¡Œ

## 1.1 Directory structure

ä½ çš„æ–‡ä»¶å¤¹ç»“æ„åº”è¯¥å¦‚ä¸‹

```
tutorial
 	|
 	+-- src
 	|
 	+-- docs
```

![image-20201120142037953](a1.assets/image-20201120142037953.png)

![image-20201120142052766](a1.assets/image-20201120142052766.png)

*ä¸è¦ç®¡æˆ‘ç°åœ¨é‡Œé¢æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Œå…ˆæŠŠç»“æ„å¼„å¥½å°±è¡Œ*

## 1.2 Compiling(ç¼–è¯‘)

éœ€è¦çš„å·¥å…·ï¼šgccã€nasm

>  æœ¬æ•™ç¨‹ä¸­çš„ç¤ºä¾‹åº”ä½¿ç”¨GNUå·¥å…·é“¾ï¼ˆgccï¼Œldï¼Œgasç­‰ï¼‰æˆåŠŸç¼–è¯‘ã€‚æ±‡ç¼–ç¤ºä¾‹ä»¥intelè¯­æ³•ç¼–å†™ï¼Œæ ¹æ®æˆ‘ä¸ªäººçš„è§‚ç‚¹ï¼Œå®ƒæ¯”GNU ASä½¿ç”¨çš„ATï¼†Tè¯­æ³•æ›´å…·å¯è¯»æ€§ã€‚è¦æ±‡ç¼–å®ƒä»¬ï¼Œæ‚¨å°†éœ€è¦å®‰è£…NASM

> æœ¬æ•™ç¨‹ä¸æ˜¯è‡ªä¸¾ç¨‹åºæ•™ç¨‹ã€‚æˆ‘ä»¬å°†ä½¿ç”¨GRUBåŠ è½½å†…æ ¸ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé¢„åŠ è½½äº†GRUBçš„è½¯ç›˜æ˜ åƒã€‚æœ‰ä¸€äº›æ•™ç¨‹å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯ï¼Œå¹¸è¿çš„æ˜¯ï¼Œæˆ‘åˆ¶ä½œäº†ä¸€ä¸ªæ ‡å‡†å›¾åƒï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚è¿™æ”¾åœ¨æ‚¨çš„â€œæ•™ç¨‹â€ï¼ˆæˆ–æ‚¨å‘½åçš„åç§°ï¼‰ç›®å½•ä¸­ã€‚

å¾ˆä¸å¹¸çš„æ˜¯ï¼Œä½œè€…è€å“¥ç»™çš„æ•™ç¨‹å’Œèµ„æºå¥½åƒéƒ½å¤±æ•ˆäº†ï¼Œæˆ‘è‡ªå·±åšé¢„åŠ è½½äº†grubçš„è½¯ç›˜æ˜ åƒä¹Ÿæ²¡åšå‡ºæ¥ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œæˆ‘ä»¬ä¸æ€•ï¼

[ç‚¹å‡»è¿›å…¥github](https://github.com/dhyey35/james-molloy-os)

æˆ‘ä»¬ç›´æ¥ä¸‹è½½ä»–çš„floppy.imgæ–‡ä»¶å°±å¯ï¼

## 1.3 Running (è¿è¡Œ)

> Bochs is an open-source x86-64 emulator. When things go completely awry, bochs will tell you, and store the processor state in a logfile, which is extremely useful. Also it can be run and rebooted much faster than a real machine. My examples will be made to run well on bochs.

> Bochsæ˜¯ä¸€ä¸ªå¼€æºx86-64ä»¿çœŸå™¨ã€‚å½“äº‹æƒ…å®Œå…¨å‡ºé”™æ—¶ï¼Œbochsä¼šå‘Šè¯‰æ‚¨ï¼Œå¹¶å°†å¤„ç†å™¨çŠ¶æ€å­˜å‚¨åœ¨æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚è€Œä¸”å®ƒçš„è¿è¡Œå’Œé‡æ–°å¯åŠ¨é€Ÿåº¦éƒ½æ¯”çœŸå®è®¡ç®—æœºå¿«å¾—å¤šã€‚æˆ‘çš„ç¤ºä¾‹å°†åœ¨bochä¸Šå¾ˆå¥½åœ°è¿è¡Œã€‚

æˆ‘ä»¬ä½¿ç”¨Bochsè¿è¡Œé¡¹ç›®

![image-20201120173744707](a1.assets/image-20201120173744707.png)

--æ¥æºã€Šorange S:ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„å®ç° ã€‹

[-->Bochså®˜ç½‘](http://bochs.sourceforge.net/)

## 1.4 Bochs

>In order to run bochs, you are going to need a bochs configuration file (bochsrc.txt). Coincidentally, a sample one is included below!

> æƒ³è¦è¿è¡Œbochsï¼Œä½ éœ€è¦è‡ªå·±å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ˆbochsrc.txtï¼‰ï¼Œä¸‹é¢æœ‰ç¤ºä¾‹

>  Take care with the locations of the bios files. These seem to change between installations, and if you made bochs from source it is very likely you don't even have them. Google their filenames, you can get them from the official bochs site among others.

> æ³¨æ„biosæ–‡ä»¶çš„ä½ç½®ï¼Œå®ƒä¼šå› ä¸ºæ¯ä¸ªäººä¸‹è½½çš„æ–¹å¼ä¸åŒè€Œäº§ç”Ÿå˜åŒ–ï¼Œå¦‚æœä½ æ˜¯ç”¨æºç å®‰è£…çš„è¯ä½ å¯èƒ½æ ¹æœ¬å°±æ²¡ç€å†™æ–‡ä»¶ï¼Œè°·æ­Œä¸€ä¸‹å®ƒä»¬çš„æ–‡ä»¶åï¼Œä½ å¯ä»¥ä»å®˜ç½‘ä¸Šè·å¾—å®ƒä»¬ã€‚

åŸä½œè€…çš„é…ç½®æ–‡ä»¶å¥½åƒæœ‰äº›è¿‡æ—¶äº†ï¼Œæˆ‘ä¸‹è½½çš„æ—¶å€™å·²ç»æ˜¯`bochs2.6.11`äº†

![image-20201120174555565](a1.assets/image-20201120174555565.png)

```
#åŸä½œè€…çš„é…ç½®æ–‡ä»¶
megs: 32
romimage: file=/usr/share/bochs/BIOS-bochs-latest, address=0xf0000
vgaromimage: /usr/share/bochs/VGABIOS-elpin-2.40
floppya: 1_44=/dev/loop0, status=inserted
boot: a
log: bochsout.txt
mouse: enabled=0
clock: sync=realtime
cpu: ips=500000
```



æˆ‘çš„é…ç½®æ–‡ä»¶

```txt
# è®¾ç½®è™šæ‹Ÿæœºå†…å­˜ä¸º32MB
megs: 32

# è®¾ç½®BIOSé•œåƒ
romimage: file=/home/michael/Downloads/bochs-2.6.11/bios/BIOS-bochs-latest 

# è®¾ç½®VGA BIOSé•œåƒ
vgaromimage: file=/home/michael/Downloads/bochs-2.6.11/bios/VGABIOS-lgpl-latest

# ç”¨è½¯ç›˜æ˜ åƒå¯åŠ¨
boot: floppy
floppya: image="floppy.img", status=inserted


# è®¾ç½®æ—¥å¿—æ–‡ä»¶
log: bochsout.txt

# å…³é—­é¼ æ ‡
mouse: enabled=0

# æ‰“å¼€é”®ç›˜
keyboard: type=mf, serial_delay=250

# è®¾ç½®ç¡¬ç›˜
ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14

```

é¦–å…ˆè¯´ä¸€ä¸‹è®¾ç½®BIOSå’ŒVGA BIOS

æˆ‘æ˜¯ç”¨çš„linuxè™šæ‹Ÿæœºï¼Œå‹ç¼©åŒ…ç›´æ¥ä¸‹è½½åˆ°äº†Downloadsé‡Œé¢

![image-20201120174847318](a1.assets/image-20201120174847318.png)

å½“æˆ‘è§£å‹å®Œæˆåï¼Œæ‰€éœ€è¦çš„é‚£ä¸¤ä¸ªæ–‡ä»¶éƒ½åœ¨biosæ–‡ä»¶å¤¹é‡Œé¢

![image-20201120175001329](a1.assets/image-20201120175001329.png)

æ‰€ä»¥è¿™ä¸ªè·¯å¾„å¤§å®¶è‡ªå·±é…ç½®å°±è¡Œäº†ã€‚

è€Œä¸”è®¾ç½®è½¯ç›˜æ˜ åƒï¼Œæ¨èçš„æ–¹æ³•æ˜¯

```txt
floppya: image="floppy.img", status=inserted
```

## 1.5 Useful scripts (æœ‰ç”¨çš„è„šæœ¬)

> We are going to be doing several things very often - making (compiling and linking) our project, and transferring the resulting kernel binary to our floppy disk image.

> æˆ‘ä»¬å°†ç»å¸¸åšå‡ ä»¶äº‹â€”â€”åˆ¶ä½œï¼ˆç¼–è¯‘å’Œé“¾æ¥ï¼‰æˆ‘ä»¬çš„é¡¹ç›®ï¼Œå¹¶å°†ç”Ÿæˆçš„å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶ä¼ è¾“åˆ°æˆ‘ä»¬çš„è½¯ç›˜æ˜ åƒä¸­ã€‚

ä¸ºäº†å®Œæˆä»¥ä¸Šå‡ ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦åˆ¶ä½œå‡ ä¸ªè„šæœ¬ã€‚

### 1.5.1 Makefile

è¿™ä¸ªæ–‡ä»¶ä¹Ÿæ˜¯æ”¾åœ¨srcæ–‡ä»¶å¤¹é‡Œ

```
# æ•™ç¨‹ä¸Šçš„åˆå§‹ç‰ˆæœ¬ï¼Œåæ­£ä¼šæŠ¥é”™ï¼Œå¤§å®¶å¯ä»¥è¯•è¯•ï¼Œä¹Ÿè®¸æ˜¯æˆ‘é”™äº†
# Makefile for JamesM's kernel tutorials.
# The C and C++ rules are already setup by default.
# The only one that needs changing is the assembler
# rule, as we use nasm instead of GNU as.

SOURCES=boot.o

CFLAGS=
LDFLAGS=-Tlink.ld
ASFLAGS=-felf

all: $(SOURCES) link 

clean:
 Â»  -rm *.o kernel

link:
 Â»  ld $(LDFLAGS) -o kernel $(SOURCES)

.s.o:
 Â»  nasm $(ASFLAGS) $<
```



æ¥è§¦è¿‡cæˆ–è€…c++çš„åŒå­¦åº”è¯¥å¬è¯´è¿‡è¿™ä¸ªï¼Œä¸è¿‡æ²¡å¬è¯´è¿‡ä¹Ÿæ²¡å…³ç³»ï¼Œå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶æ¥æŒ‡å®šå¦‚ä½•ç¼–è¯‘é“¾æ¥ä»¥åŠæŒ‡å®šç¼–è¯‘å“ªäº›æ–‡ä»¶ã€‚æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„æœ€æ¥è¿‘æˆ‘æ‰€å¤„å¹´ä»£çš„ä»£ç é‡Œé¢ï¼Œä»–ä½¿ç”¨çš„é‚£ä¸ªMakefileä¹Ÿæ˜¯å­˜åœ¨é—®é¢˜çš„ï¼ˆä¹Ÿè®¸æ˜¯æˆ‘çš„ç”µè„‘æœ‰é—®é¢˜ğŸ˜“ï¼‰ï¼Œæ€»ä¹‹æˆ‘ç»è¿‡ä¸æ–­è¯•é”™ã€ç™¾åº¦ã€è°·æ­Œï¼Œå¼„å‡ºäº†ä¸€ä»½è¿™ä¸ªã€‚

```
# Makefile for JamesM's kernel tutorials.
# The C and C++ rules are already setup by default.
# The only one that needs changing is the assembler 
# rule, as we use nasm instead of GNU as.

SOURCES=boot.o
CFLAGS=-nostdlib -nostdinc -fno-builtin -fno-stack-protector -m32
LDFLAGS=-Tlink.ld
ASFLAGS=-felf32

all: $(SOURCES) link

clean:
	-rm *.o kernel

link:
	ld -m elf_i386 $(LDFLAGS) -o kernel $(SOURCES)

.s.o:
	nasm $(ASFLAGS) $<
```

æˆ‘è¦è¯´ä¸€ä¸‹ï¼Œè¿™é‡Œçš„boot.oæ˜¯ä¹‹åæˆ‘ä»¬ç¬¬ä¸€æ­¥çš„æ—¶å€™ç¼–è¯‘ç”Ÿæˆçš„ï¼Œä¸è¦æƒŠæ…Œï¼Œå…ˆå†™ä¸Šï¼Œä»¥åæˆ‘ä»¬ä¼šç»å¸¸å¾€è¿™ä¸ªä½ç½®æ·»åŠ æ–‡ä»¶åçš„ã€‚

### 1.5.2 link.ld

ä¹Ÿæ˜¯æ”¾åœ¨srcæ–‡ä»¶å¤¹é‡Œ

```
/* Link.ld -- Linker script for the kernel - ensure everything goes in the */
/*            Correct place.  */
/*            Original file taken from Bran's Kernel Development */
/*            tutorials: http://www.osdever.net/bkerndev/index.php. */

ENTRY(start)
SECTIONS
{
  .text 0x100000 :
  {
    code = .; _code = .; __code = .;
    *(.text)
    . = ALIGN(4096);
  }

  .data :
  {
     data = .; _data = .; __data = .;
     *(.data)
     *(.rodata)
     . = ALIGN(4096);
  }

  .bss :
  {
    bss = .; _bss = .; __bss = .;
    *(.bss)
    . = ALIGN(4096);
  }

  end = .; _end = .; __end = .;
}
```

> è¯¥è„šæœ¬å‘Šè¯‰LDå¦‚ä½•è®¾ç½®æˆ‘ä»¬çš„å†…æ ¸æ˜ åƒã€‚é¦–å…ˆï¼Œå®ƒå‘Šè¯‰LDæˆ‘ä»¬äºŒè¿›åˆ¶æ–‡ä»¶çš„å¼€å§‹ä½ç½®åº”ä¸ºç¬¦å·â€œå¼€å§‹â€ã€‚ç„¶åï¼Œå®ƒå‘Šè¯‰LD .textèŠ‚ï¼ˆæ‰€æœ‰ä»£ç éƒ½åœ¨è¯¥èŠ‚ä¸­ï¼‰é¦–å…ˆå‡ºç°ï¼Œå¹¶ä¸”åº”ä»0x100000ï¼ˆ1MBï¼‰å¼€å§‹ã€‚ .dataï¼ˆå·²åˆå§‹åŒ–çš„é™æ€æ•°æ®ï¼‰å’Œ.bssï¼ˆæœªåˆå§‹åŒ–çš„é™æ€æ•°æ®ï¼‰åº”è¯¥ç´§éšå…¶åï¼Œå¹¶ä¸”æ¯ä¸ªé¡µé¢éƒ½åº”å¯¹é½ï¼ˆALIGNï¼ˆ4096ï¼‰ï¼‰ã€‚ Linux GCCè¿˜æ·»åŠ äº†ä¸€ä¸ªé¢å¤–çš„æ•°æ®éƒ¨åˆ†ï¼š.rodataã€‚è¿™æ˜¯åªè¯»çš„åˆå§‹åŒ–æ•°æ®ï¼Œä¾‹å¦‚å¸¸é‡ã€‚ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†å…¶ä¸.dataèŠ‚æ†ç»‘åœ¨ä¸€èµ·ã€‚

### 1.5.3 update_image.sh

æ”¾åœ¨ä½ çš„é¡¹ç›®çš„æ ¹ç›®å½•é‡Œ

> ä¸€ä¸ªä¸é”™çš„å°è„šæœ¬ï¼Œå®ƒå°†æ‚¨çš„æ–°å†…æ ¸äºŒè¿›åˆ¶æ–‡ä»¶æˆ³å…¥è½¯ç›˜æ˜ åƒæ–‡ä»¶ï¼ˆå‡å®šæ‚¨å·²åˆ›å»ºç›®å½•/ mntï¼‰ã€‚æ³¨æ„ï¼šæ‚¨éœ€è¦åœ¨$ PATHä¸­ä½¿ç”¨/ sbinæ‰èƒ½ä½¿ç”¨losetupã€‚

```
#!/bin/bash

sudo losetup /dev/loop0 floppy.img
sudo mount /dev/loop0 /mnt
sudo cp src/kernel /mnt/kernel
sudo umount /dev/loop0
sudo losetup -d /dev/loop0
```

å®è¯å®è¯´ï¼Œæˆ‘æ²¡çœ‹æ‡‚ä»–è¯´çš„æ˜¯ä»€ä¹ˆæ„æ€ï¼Œæˆ‘æŠŠæˆ‘çš„ç»™å¤§å®¶çœ‹çœ‹

```
sudo losetup /dev/loop10 floppy.img
sudo mount /dev/loop10 /mnt2
sudo cp src/kernel /mnt2/kernel
sudo umount /dev/loop10
sudo losetup -d /dev/loop10
```

ä½ éœ€è¦é€€åˆ°æ ¹ç›®å½•ï¼ˆæ³¨æ„ä¸æ˜¯ç”¨æˆ·ç›®å½•ï¼Œæ²¡æœ‰æ³¢æµªçº¿~çš„é‚£ç§ï¼‰ï¼Œè¦ä½¿ç”¨`cd /`å‘½ä»¤é€€å›åˆ°æ ¹ç›®å½•ã€‚åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»º`mnt2`æˆ–è€…å…¶ä»–æ–‡ä»¶å¤¹éƒ½è¡Œï¼Œåˆ«ç”¨`mnt`ï¼Œå®ƒ`read only`



### 1.5.4 run_bochs.sh

> This script will setup a loopback device, run bochs on it, then disconnect it.

è¿˜æ˜¯è€æ ·å­ï¼Œæˆ‘ä»¬çœ‹çœ‹ä½œè€…æ€ä¹ˆå†™çš„

```
#!/bin/bash

# run_bochs.sh
# mounts the correct loopback device, runs bochs, then unmounts.

sudo /sbin/losetup /dev/loop0 floppy.img
sudo bochs -f bochsrc.txt
sudo /sbin/losetup -d /dev/loop0
```

ä¸‹é¢æ˜¯æˆ‘å†™çš„ï¼š

```
sudo losetup /dev/loop10 floppy.img
sudo bochs -f bochsrc.txt
sudo losetup -d /dev/loop10
```

### 1.5.5 æœ€åbbä¸€å¥

å¥½åƒè¦è¿è¡Œè¿™äº›è„šæœ¬ï¼Œè¦ç”¨`bash xx.sh`ï¼Œè€Œä¸èƒ½ç”¨`./xx.sh`ï¼Œå¦åˆ™ä¼šå‡ºç°`no command`æŠ¥é”™ã€‚